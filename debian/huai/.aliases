# ---------------------------------------------------------
# [1] Basic System
# ---------------------------------------------------------
alias ls='ls --color=auto'
alias grep='grep --color=auto'
alias c="clear"
alias ..='cd ..'

# ---------------------------------------------------------
# [2] System & Time
# ---------------------------------------------------------
# Display UTC & CST simultaneously
alias now='echo "UTC: $(date -u +%H:%M:%S) | CST: $(TZ=Asia/Shanghai date +%H:%M:%S)"'
# Sleep 60s then shutdown
alias P="sleep 60 && shutdown now"
alias R="systemctl reboot"
alias rsyncdir="rsync -avzh --delete" 

# ---------------------------------------------------------
# [3] Navigation (Strict mode: use &&)
# ---------------------------------------------------------
# Safety: Only cd if mount-data succeeds (exit code 0)
alias cddata="mount-data && cd /data"
alias cdappdata="mount-data && cd /data/appdata"
alias cdwww="mount-data && cd /data/www"
alias cdmedia="mount-data && cd /data/media"
alias cdlinux="cd /home/huai/linux"
alias cdusb="cd /home/huai/usb"

# NFS Mount Function
mount-data() {
    if ! mountpoint -q /data; then
        sudo mount -t nfs4 -o sec=sys 10.0.0.21:/ /data
    fi
}

# =================================================================
# 音频管理系统 (PipeWire/wpctl)
# =================================================================

# 1. 辅助函数：通过设备名称获取 wpctl 的数字 ID
_get_wp_id() {
    # 在 wpctl status 的 Sinks 部分查找匹配名称的 ID
    wpctl status | grep -A 10 "Sinks:" | grep -i "$1" | grep -oE '[0-9]+\.' | head -n1 | tr -d '.'
}

# 2. 核心音量控制函数
vol() {
    local target=$1
    
    # wpctl 处理音量：支持 5%+ 或 0.50(50%)
    if [[ "$target" == *"+"* || "$target" == *"-"* ]]; then
        wpctl set-volume @DEFAULT_AUDIO_SINK@ "$target"
    else
        # 转换为小数格式 (50 -> 0.50)
        local val=$(echo "scale=2; $target / 100" | bc)
        wpctl set-volume @DEFAULT_AUDIO_SINK@ "$val"
    fi

    # 触发状态栏更新 (dwm/dwl)
    pkill -RTMIN+2 -f dwm_status.sh
}

# 3. 核心切换函数：设置默认 + 强制迁移流 + 设音量
set_audio() {
    local dev_name="$1"
    local vol_level="$2"
    local id=$(_get_wp_id "$dev_name")

    if [ -n "$id" ]; then
        # A. 设置系统默认输出
        wpctl set-default "$id"

        # B. 强制迁移所有正在播放的流 (目前最轻量的方法仍是调用 pactl 迁移指令)
        # 如果不执行这一步，MPD 等正在播放的程序不会在切换后立刻跳转
        pactl list sink-inputs short | cut -f1 | xargs -I{} pactl move-sink-input {} "$id" 2>/dev/null

        # C. 设置初始音量
        vol "$vol_level"
        
        echo "已切换至设备 [$id]: $dev_name (音量: ${vol_level}%)"
    else
        echo "错误: 未找到匹配 '$dev_name' 的设备"
    fi
}

# =================================================================
# 快捷键映射 (Aliases)
# =================================================================

# 设备切换 (0-3)
alias 0="set_audio 'USB2.0_Device' 50"
alias 1="set_audio 'Built-in Audio' 50"
alias 2="set_audio 'E6:30:6D:65:E0:5F' 80"
alias 3="set_audio 'GWH810PRO' 70"

# 日常控制
alias volup="vol 5%+"
alias voldown="vol 5%-"
alias volmute="wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle && pkill -RTMIN+2 -f dwm_status.sh"

# ---------------------------------------------------------
# [5] MPC (Music Player Daemon)
# ---------------------------------------------------------
alias s="mpc stop"
alias p="mpc play"
alias nm="mpc next"
alias mpause="mpc pause"
alias pl="vim /home/huai/.config/mpd/playlists/all.m3u"

# ---------------------------------------------------------
# [6] Git Shortcuts
# ---------------------------------------------------------
alias gaa='git add -A'
alias gpl='git pull'
alias gpu='git push'
alias gcl='git clone'
alias gst='git status'
alias gl='git log'

gc() {
    if [ $# -eq 0 ]; then
        git commit -v
    else
        git commit -m "$*"
    fi
}

# ---------------------------------------------------------
# [7] Script Shortcuts
# ---------------------------------------------------------
alias win="/usr/bin/bash /home/huai/.config/win.sh"
alias wol="/usr/bin/bash /home/huai/.config/wol.sh"
alias py="python3"

np() {
    # Use [[ ]] for safety
    if [[ -f "/home/huai/.config/wallpaperchange.sh" ]]; then
        sh "/home/huai/.config/wallpaperchange.sh"
    fi
}
